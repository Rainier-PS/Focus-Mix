<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nutri Mix — Quick Allergy Test & Personalized Snack Recommendations</title>

  <meta name="description" content="Take the Nutri Mix quick allergy screening and get personalized snack recommendations tailored to your needs." />

  <meta name="keywords" content="allergy test, snack recommendation, healthy snacks, Focus Mix" />

  <link rel="canonical" href="https://rainier-ps.github.io/Focus-Mix/" />

  <link rel="icon" href="/favicon.ico" />

  <meta property="og:title" content="Focus Mix — Quick Allergy Test & Personalized Snack Recommendations" />
  <meta property="og:description" content="Fast, easy allergy screening with personalized snack suggestions. Try Focus Mix now." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://rainier-ps.github.io/Focus-Mix/" />
  <meta property="og:image" content="https://yourdomain.com/preview.jpg" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Focus Mix — Quick Allergy Test & Personalized Snack Recommendations" />
  <meta name="twitter:description" content="Fast, easy allergy screening with personalized snack suggestions. Try Focus Mix now." />
  <meta name="twitter:image" content="https://yourdomain.com/preview.jpg" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          borderRadius: { 'xl': '1rem' },
          boxShadow: { 'soft': '0 6px 18px rgba(8,15,29,0.08)' }
        }
      }
    }
  </script>
  <style>
    .rating-radio:focus + label {
      outline: 3px solid rgba(99,102,241,0.25);
    }
    .btn-animate {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-animate:hover {
      transform: translateY(-1px) scale(1.03);
      box-shadow: 0 8px 20px rgba(99,102,241,0.25);
    }
    .btn-animate:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 4px 12px rgba(99,102,241,0.15);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      background: transparent;
      filter: invert(0);
    }

    .dark input[type="number"]::-webkit-inner-spin-button,
    .dark input[type="number"]::-webkit-outer-spin-button {
      filter: invert(1);
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-4">
  <main class="w-full max-w-2xl">
    <section class="bg-white dark:bg-gray-900 rounded-2xl shadow-soft p-6 md:p-8">
    <header class="flex flex-col gap-4">
      <img 
        src="https://raw.githubusercontent.com/Rainier-PS/Focus-Mix/main/images/site/Trail%20Mix%20Banner.jpg" 
        alt="Focus Mix Banner" 
        class="w-full h-32 object-cover rounded-xl"
      />

      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-2xl md:text-3xl font-semibold">Nutri Mix — Quick Match</h1>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
            Complete a short, safe test and get a personalized trail-mix recommendation.
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button id="themeToggle" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none" aria-pressed="false">
            <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zM4.22 4.22a1 1 0 011.42 0l.7.7a1 1 0 11-1.42 1.42l-.7-.7a1 1 0 010-1.42zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zM4.22 15.78a1 1 0 010-1.42l.7-.7a1 1 0 011.42 1.42l-.7.7a1 1 0 01-1.42 0zM10 16a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM15.78 15.78a1 1 0 01-1.42 0l-.7-.7a1 1 0 011.42-1.42l.7.7a1 1 0 010 1.42zM17 10a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM15.78 4.22a1 1 0 010 1.42l-.7.7A1 1 0 0113.96 4.9l.7-.7a1 1 0 011.42 0z" /></svg>
            <span class="text-sm">Theme</span>
          </button>
        </div>
      </div>
    </header>


      <form id="mixForm" class="mt-6 grid gap-6" novalidate>
        <fieldset class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl" aria-labelledby="allergyLegend">
        <h3 id="allergyLegend" class="text-lg font-medium mb-2">
          Allergy screening 
          <span class="text-sm text-gray-500 dark:text-gray-400">(required)</span>
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
          Please check any allergens you may have. Optional flavor items are considered separately.
        </p>

        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="allergies" value="nuts" class="allergy h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>Nuts (almonds, cashews)</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="allergies" value="chocolate" class="allergy h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>Chocolate</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="allergies" value="driedfruit" class="allergy h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>Dried fruit</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="allergies" value="gluten" class="allergy h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>Gluten / Wheat</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" name="allergies" value="dairy" class="allergy h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>Cheese / Dairy</span>
          </label>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="noAllergies" name="allergies" value="none" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
            <span>No allergies</span>
          </label>

          <p id="allergyNotice" class="text-sm text-red-600 dark:text-red-400 mt-2 hidden">
            *Please complete the allergy screening to continue.
          </p>
        </div>
      </fieldset>

        <fieldset class="p-4 bg-gray-50 dark:bg-gray-800 rounded-xl" aria-labelledby="ratingLegend">
          <h3 id="ratingLegend" class="font-medium">Quick self-rating</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
            Rate how you feel right now on a scale of 1 (low) to 5 (high).
          </p>

          <div class="mt-4 grid gap-4">
            <div>
              <label class="block text-sm font-medium">Energy</label>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex gap-2 items-center" role="radiogroup" aria-label="Energy rating"></div>
                <div class="ml-auto text-sm text-gray-500 self-center" id="energyVal">3</div>
              </div>
              <div class="mt-2" id="energyRadios"></div>
            </div>

            <div>
              <label class="block text-sm font-medium">Focus</label>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex gap-2 items-center" role="radiogroup" aria-label="Focus rating"></div>
                <div class="ml-auto text-sm text-gray-500 self-center" id="focusVal">3</div>
              </div>
              <div class="mt-2" id="focusRadios"></div>
            </div>

            <div>
              <label class="block text-sm font-medium">Mood</label>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex gap-2 items-center" role="radiogroup" aria-label="Mood rating"></div>
                <div class="ml-auto text-sm text-gray-500 self-center" id="moodVal">3</div>
              </div>
              <div class="mt-2" id="moodRadios"></div>
            </div>
          </div>
        </fieldset>

        <div class="flex gap-3 items-center">
          <button id="submitBtn" type="submit" disabled
            class="btn-animate inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl 
                  bg-indigo-400 text-white cursor-not-allowed 
                  disabled:opacity-60 disabled:cursor-not-allowed 
                  hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            Get Recommendation
          </button>
          <button type="button" id="resetBtn" class="btn-animate px-3 py-2 rounded-xl border dark:border-gray-700 text-sm">Reset</button>
        </div>
      </form>

      <div id="result" class="mt-6 hidden">
        <div class="rounded-xl p-4 bg-gradient-to-r from-white to-gray-50 dark:from-gray-900 dark:to-gray-900/60 border dark:border-gray-800 shadow-sm">
          <h2 class="text-lg font-semibold" id="resultTitle">Your Recommendation</h2>
          <p class="mt-2 text-sm text-gray-600 dark:text-gray-400" id="resultReason"></p>

          <div class="mt-4 grid gap-3 sm:grid-cols-2">
            <div class="p-4 rounded-xl bg-white dark:bg-gray-800 border dark:border-gray-700 shadow-sm">
              <h3 class="font-medium">Mix Variant</h3>
              <p class="mt-1 text-sm" id="variantName"></p>
              <ul class="mt-2 text-sm list-disc list-inside text-gray-600 dark:text-gray-400" id="variantIngredients"></ul>
              <div class="mt-3 flex gap-2">
                <button id="copyBtn" class="btn-animate px-3 py-1 rounded-lg border text-sm">Copy recipe</button>
              </div>
            </div>
            <div class="p-4 rounded-xl bg-white dark:bg-gray-800 border dark:border-gray-700 shadow-sm">
              <h3 class="font-medium">Why this fits</h3>
              <p class="mt-1 text-sm text-gray-600 dark:text-gray-400" id="variantWhy"></p>
              
            </div>
          </div>

          <div class="mt-4 text-sm text-gray-500">You can show this recommendation to the volunteers preparing your snack bags. Allergen-safe alternatives will be used where necessary.</div>
        </div>

        <div class="mt-4 p-4 rounded-xl bg-white dark:bg-gray-800 border dark:border-gray-700 shadow-sm">
          <h3 class="font-medium">Festival summary (local)</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">This panel shows aggregate results stored on this device (localStorage).</p>
          <div class="mt-3 text-sm space-y-2" id="summaryArea">
            <div id="mostCommon"></div>
            <div id="avgScores"></div>
          </div>
        </div>

        <div class="mt-4 p-4 rounded-xl bg-white dark:bg-gray-800 border dark:border-gray-700 shadow-sm">
          <h3 class="font-medium">Organizer Tools</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
            All entries are saved automatically in this browser.
          </p>
          <div class="mt-3 flex gap-2">
            <button id="downloadCSV" class="btn-animate px-3 py-1 rounded-lg border text-sm">
              Download CSV
            </button>
            <button id="clearData" class="btn-animate px-3 py-1 rounded-lg border text-sm">
              Clear data
            </button>
          </div>
          <div id="ingredientCalculator" class="mt-6 p-4 bg-gray-100 dark:bg-gray-900 rounded-xl"></div>
        </div>
      </div>
    </section>
    <footer class="text-center text-xs text-gray-500 dark:text-gray-400 mt-4">Not medical advice! For demonstration and educational purposes only.</footer>
  </main>

  <button id="backToTop"
    class="btn-animate hidden fixed bottom-6 right-6 w-12 h-12 flex items-center justify-center rounded-full bg-indigo-600 text-white shadow-lg hover:bg-indigo-700 dark:bg-gray-700 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-400"
    aria-label="Back to top">
    ↑
  </button>

<script>
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const root = document.documentElement;
  function applyInitialTheme() {
    const saved = localStorage.getItem('fm-theme');
    if (saved) {
      if (saved === 'dark') root.classList.add('dark');
      else root.classList.remove('dark');
      $('#themeToggle').setAttribute('aria-pressed', saved === 'dark');
    } else {
      if (prefersDark) root.classList.add('dark');
      else root.classList.remove('dark');
      $('#themeToggle').setAttribute('aria-pressed', prefersDark);
    }
  }
  applyInitialTheme();
  $('#themeToggle').addEventListener('click', () => {
    const isDark = root.classList.toggle('dark');
    localStorage.setItem('fm-theme', isDark ? 'dark' : 'light');
    $('#themeToggle').setAttribute('aria-pressed', isDark);
  });

  function buildRadios(containerId, name, defaultValue = 3) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for (let i=1;i<=5;i++){
      const id = `${name}-${i}`;
      const radio = document.createElement('input');
      radio.type = 'radio'; radio.name = name; radio.value = String(i);
      radio.id = id; radio.className = 'sr-only rating-radio';
      if (i===defaultValue) radio.checked = true;

      const label = document.createElement('label');
      label.setAttribute('for', id);
      label.className = 'inline-flex items-center justify-center w-12 h-12 mx-1 rounded-xl border dark:border-gray-700 cursor-pointer select-none transition-colors';
      label.textContent = i;
      label.setAttribute('aria-hidden','true');

      radio.addEventListener('change', () => {
        $(`#${name}Val`).textContent = i;
        Array.from(container.querySelectorAll('label')).forEach(l=>l.classList.remove('bg-indigo-50','dark:bg-indigo-800','border-indigo-400'));
        label.classList.add('bg-indigo-50','dark:bg-indigo-800','border-indigo-400');
      });

      container.appendChild(radio);
      container.appendChild(label);

      if (i===defaultValue) label.classList.add('bg-indigo-50','dark:bg-indigo-800','border-indigo-400');
    }
  }

  buildRadios('energyRadios','energy',3);
  buildRadios('focusRadios','focus',3);
  buildRadios('moodRadios','mood',3);

  const form = $('#mixForm');
  const result = $('#result');

  const VARIANTS = [
    {
      id: 'brain-boost',
      name: 'Brain Boost',
      ingredients: [
        { name: 'Cashews or Almonds (source of magnesium and healthy fats)', base: 1 },
        { name: 'Dark Chocolate (contains flavonoids and antioxidants)', base: 1 },
        { name: 'Cranberries (rich in polyphenols and natural sugars)', base: 1 }
      ],
      reason: 'This mix combines flavonoids from dark chocolate, magnesium and healthy fats from nuts, and polyphenols from cranberries. Together, these nutrients may support blood flow to the brain, reduce stress, and provide antioxidants that help protect cells—supporting focus and memory.'
    },
    {
      id: 'calm-focus',
      name: 'Calm Focus',
      ingredients: [
        { name: 'Cashews or Almonds (magnesium helps regulate stress and nerve function)', base: 1 },
        { name: 'Cranberries (polyphenols and natural sugars for steady energy)', base: 1 }
      ],
      reason: 'Magnesium from nuts contributes to nerve and muscle function while helping reduce feelings of stress. Cranberries supply polyphenols that may support memory and antioxidants that reduce oxidative stress, making this a gentle option for calm concentration.'
    },
    {
      id: 'energy-kick',
      name: 'Energy Kick',
      ingredients: [
        { name: 'Cashews or Almonds (healthy fats for sustained energy)', base: 1 },
        { name: 'Cranberries (natural fruit sugars for a quick boost)', base: 1 },
        { name: 'Dark Chocolate (mild caffeine + flavonoids for alertness)', base: 1 }
      ],
      reason: 'Cranberries provide quick energy through natural sugars, while nuts deliver healthy fats for longer-lasting energy. Dark chocolate adds mild caffeine and flavonoids that may enhance alertness and cognitive performance, making this a good choice when energy feels low.'
    }
  ];

  function adjustIngredients(ingredients, allergies, scores) {
    const { energy, focus, mood } = scores;
    return ingredients.map(ing => {
      let ratio = (typeof ing.base === 'number') ? ing.base : 1;
      if (allergies.includes('nuts') && /Cashews|Almonds|Nuts/gi.test(ing.name)) {
        ratio = 0;
      }
      if (allergies.includes('chocolate') && /Dark Chocolate|Chocolate/gi.test(ing.name)) {
        ratio = 0;
      }
      if (allergies.includes('driedfruit') && /Cranberries|Dried fruit/gi.test(ing.name)) {
        ratio = 0;
      }
      if (ratio > 0) {
        if (/Cashews|Almonds/gi.test(ing.name)) {
          ratio *= (0.6 + 0.12 * (6 - energy));
        }
        if (/Dark Chocolate|Chocolate/gi.test(ing.name)) {
          ratio *= (0.2 + 0.2 * focus);
        }
        if (/Cranberries|Dried fruit/gi.test(ing.name)) {
          ratio *= (0.5 + 0.125 * mood);
        }
        if (ratio < 0) ratio = 0;
      }
      return { name: ing.name, ratio };
    });
  }

  function normalizeIngredients(adjusted) {
    const total = adjusted.reduce((sum, a) => sum + a.ratio, 0);
    if (total === 0) {
      return adjusted.map(a => ({ name: a.name, percent: 0 }));
    }
    let raw = adjusted.map(a => ({ name: a.name, rawPercent: (a.ratio / total) * 100 }));
    let intParts = raw.map(r => Math.floor(r.rawPercent));
    let remainder = 100 - intParts.reduce((s,n) => s + n, 0);
    const withFraction = raw.map((r, idx) => ({ idx, frac: r.rawPercent - Math.floor(r.rawPercent) }))
                           .sort((a,b) => b.frac - a.frac);
    for (let i=0;i<remainder;i++) {
      intParts[withFraction[i].idx] += 1;
    }
    return intParts.map((p, i) => ({ name: adjusted[i].name, percent: p }));
  }

  function chooseVariant(scores, allergies) {
    const { energy, focus, mood } = scores;
    let choice = VARIANTS[0];
    if (energy <= 2 && energy < focus && energy < mood) choice = VARIANTS[2];
    else if (focus <= 2 && focus <= mood) choice = VARIANTS[0];
    else if (mood <= 2 && mood < focus) choice = VARIANTS[1];
    else {
      const min = Math.min(energy, focus, mood);
      if (min === energy) choice = VARIANTS[2];
      else if (min === focus) choice = VARIANTS[0];
      else choice = VARIANTS[1];
    }
    const adjusted = adjustIngredients(choice.ingredients, allergies, scores);
    const normalized = normalizeIngredients(adjusted);
    const finalIngredients = normalized.map(n => {
      const adj = adjusted.find(a => a.name === n.name);
      if (adj && adj.ratio === 0) {
        return { name: n.name, percent: 0, removed: true };
      } else {
        return { name: n.name, percent: n.percent, removed: false };
      }
    });
    return { variant: choice, ingredients: finalIngredients };
  }

  function getFormValues() {
    const checked = Array.from(form.querySelectorAll('input[name="allergies"]:checked')).map(i=>i.value);
    const allergies = checked.includes('none') ? [] : checked;
    const energy = Number(form.querySelector('input[name="energy"]:checked').value);
    const focus = Number(form.querySelector('input[name="focus"]:checked').value);
    const mood = Number(form.querySelector('input[name="mood"]:checked').value);
    return { allergies, scores: {energy, focus, mood} };
  }

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    try {
      const { allergies, scores } = getFormValues();
      if (allergies.includes('none') && allergies.length > 1) {
        alert('If you selected "No allergies", please uncheck other allergy boxes.');
        return;
      }
      displayRecommendation(scores, allergies);
    } catch (err) {
      alert('Please complete the form (choose ratings and confirm allergy choices).');
      renderIngredientCalculator(ingredients);

    }
  });

  $('#resetBtn').addEventListener('click', () => {
    form.reset();
    buildRadios('energyRadios','energy',3);
    buildRadios('focusRadios','focus',3);
    buildRadios('moodRadios','mood',3);
    result.classList.add('hidden');
  });

  function renderIngredients(ingredients) {
    $('#variantIngredients').innerHTML = '';
    ingredients.forEach(i => {
      const li = document.createElement('li');
      if (i.removed || i.percent === 0) {
        li.textContent = `[${i.name.split(' (')[0]} removed due to allergies]`;
      } else {
        li.textContent = `${i.name} — ${i.percent}% of mix`;
      }
      $('#variantIngredients').appendChild(li);
    });
  }

  function displayRecommendation(scores, allergies) {
    const { variant, ingredients } = chooseVariant(scores, allergies);
    $('#variantName').textContent = variant.name;
    $('#variantIngredients').innerHTML = '';
    renderIngredients(ingredients);

    const removedList = ingredients.filter(i => i.removed).map(i => i.name.split(' (')[0]);

    if (removedList.length > 0) {
      $('#variantWhy').innerHTML = `${variant.reason}<br><strong>Note:</strong> ${removedList.join(', ')} removed due to allergies.`;
    } else {
      $('#variantWhy').textContent = variant.reason;
    }

    $('#resultReason').textContent =
      `Based on your ratings (Energy: ${scores.energy}, Focus: ${scores.focus}, Mood: ${scores.mood}) and allergy choices, here is a recommended mix.`;

    result.classList.remove('hidden');

    $('#copyBtn').onclick = () => {
      const text = `${variant.name}\nIngredients:\n- ${ingredients.map(i => i.removed ? `[${i.name.split(' (')[0]} removed due to allergies]` : `${i.name} — ${i.percent}%`).join('\n- ')}`;
      navigator.clipboard?.writeText(text).then(() =>
        alert('Recipe copied to clipboard.')
      );
    };

    renderIngredientCalculator(ingredients);

    saveLocalResult({
      timestamp: Date.now(),
      scores,
      allergies,
      variant: variant.id
    });
  }

  const STORAGE_KEY = 'focusmix-data-v1';
  function loadLocalData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) { return []; }
  }
  function saveLocalResult(entry) {
    const data = loadLocalData();
    data.push(entry);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function clearLocalData() {
    localStorage.removeItem(STORAGE_KEY);
    renderSummary();
  }

  function renderSummary() {
    const data = loadLocalData();
    if (data.length === 0) {
      $('#summaryArea').innerHTML = '<div class="text-sm text-gray-500">No saved entries yet.</div>';
      return;
    }
    const avg = data.reduce((acc,d)=>{ acc.energy+=d.scores.energy; acc.focus+=d.scores.focus; acc.mood+=d.scores.mood; return acc; },{energy:0,focus:0,mood:0});
    avg.energy = (avg.energy / data.length).toFixed(2);
    avg.focus = (avg.focus / data.length).toFixed(2);
    avg.mood = (avg.mood / data.length).toFixed(2);
    const counts = {};
    data.forEach(d=> counts[d.variant] = (counts[d.variant]||0)+1);
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const mostCommon = sorted[0] ? sorted[0][0] : '—';
    const variantName = VARIANTS.find(v=>v.id===mostCommon)?.name || 'Mixed';
    $('#mostCommon').innerHTML = `<strong>Most recommended mix:</strong> ${variantName} (${counts[mostCommon] || 0} participants)`;
    $('#avgScores').innerHTML = `<strong>Average ratings:</strong> Energy ${avg.energy} · Focus ${avg.focus} · Mood ${avg.mood} (from ${data.length} entries)`;
  }

  renderSummary();

  const backToTop = document.getElementById('backToTop');
  window.addEventListener('scroll', () => {
    if (window.scrollY > 200) {
      backToTop.classList.remove('hidden');
    } else {
      backToTop.classList.add('hidden');
    }
  });
  backToTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  const noAllergies = document.getElementById("noAllergies");
  const allergyOptions = document.querySelectorAll("input.allergy");

  noAllergies.addEventListener("change", () => {
    if (noAllergies.checked) {
      allergyOptions.forEach(opt => opt.checked = false);
    }
  });

  allergyOptions.forEach(opt => {
    opt.addEventListener("change", () => {
      if (opt.checked) {
        noAllergies.checked = false;
      }
    });
  });

  const submitBtn = document.getElementById("submitBtn");
  const allergyNotice = document.getElementById("allergyNotice");

  function validateAllergies() {
    const checked = Array.from(document.querySelectorAll('input[name="allergies"]:checked'));
    if (checked.length === 0) {
      submitBtn.disabled = true;
      allergyNotice.classList.remove("hidden");
      return false;
    }
    if (checked.some(c => c.value === "none") && checked.length > 1) {
      submitBtn.disabled = true;
      allergyNotice.textContent = "Please choose either 'No allergies' or specific allergies, not both.";
      allergyNotice.classList.remove("hidden");
      return false;
    }
    submitBtn.disabled = false;
    allergyNotice.classList.add("hidden");
    allergyNotice.textContent = "Please complete the allergy screening to continue.";
    return true;
  }

  validateAllergies();
  $$('input[name="allergies"]').forEach(input => {
    input.addEventListener("change", validateAllergies);
  });

  function renderIngredientCalculator(ingredients) {
    const container = document.getElementById("ingredientCalculator");
    container.innerHTML = "";

    const inputWrapper = document.createElement("div");
    inputWrapper.className = "mb-4";
    const label = document.createElement("label");
    label.className = "block text-sm font-medium mb-1";
    label.textContent = "Serving size (grams)";
    const input = document.createElement("input");
    input.type = "number";
    input.min = "1";
    input.value = 35; // default serving size
    input.className = "w-28 p-2 border rounded bg-white text-gray-900 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-indigo-500";
    inputWrapper.appendChild(label);
    inputWrapper.appendChild(input);
    container.appendChild(inputWrapper);

    const table = document.createElement("table");
    table.className = "min-w-full text-sm border-collapse";
    const thead = document.createElement("thead");
    thead.innerHTML = `
      <tr class="border-b">
        <th class="text-left p-2">Ingredient</th>
        <th class="text-left p-2">Percent</th>
        <th class="text-left p-2">Grams</th>
      </tr>`;
    table.appendChild(thead);
    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    container.appendChild(table);

    function updateTable() {
      const serving = parseFloat(input.value) || 35;
      tbody.innerHTML = "";
      ingredients.forEach(i => {
        const grams = (i.percent / 100) * serving;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td class="p-2">${i.removed ? `[${i.name.split(' (')[0]} removed]` : i.name}</td>
          <td class="p-2">${i.percent}%</td>
          <td class="p-2">${i.removed ? "—" : grams.toFixed(1)} g</td>
        `;
        tbody.appendChild(row);
      });

      const totalRow = document.createElement("tr");
      totalRow.className = "font-semibold border-t";
      totalRow.innerHTML = `
        <td class="p-2">Total</td>
        <td class="p-2">100%</td>
        <td class="p-2">${serving.toFixed(1)} g</td>
      `;
      tbody.appendChild(totalRow);
    }

    updateTable();
    input.addEventListener("input", updateTable);
  }

  function downloadCSV() {
    const data = loadLocalData();
    if (data.length === 0) {
      alert("No data saved yet.");
      return;
    }
    const headers = ["Timestamp","Energy","Focus","Mood","Allergies","Variant"];
    const rows = data.map(d => [
      new Date(d.timestamp).toISOString(),
      d.scores.energy,
      d.scores.focus,
      d.scores.mood,
      d.allergies.join("|"),
      d.variant
    ]);
    const csv = [headers, ...rows]
    .map(r => r.map(val => `"${val}"`).join(","))
    .join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "nutrimix-data.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  $('#downloadCSV').onclick = downloadCSV;
  $('#clearData').onclick = () => {
    if (confirm('Clear local saved data?')) clearLocalData();
  };
</script>
</body>
</html>
